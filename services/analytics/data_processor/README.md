# Data Processor

## Назначение

Сервис `data_processor` является вычислительным ядром платформы "Trade Forge". Его основная задача — **расчет технических индикаторов** на основе потока сырых свечей. Сервис обогащает данные, превращая их в информацию, пригодную для анализа и исполнения торговых стратегий.

## Архитектура и Режимы Работы

Сервис спроектирован для работы в двух изолированных режимах (контурах), чтобы обеспечить максимальную производительность для критически важных задач и масштабируемость для фоновых вычислений.

### 1. Real-Time (RT) Processor

-   **Режим запуска:** `realtime`
-   **Триггер:** Постоянно слушает Kafka-топик `trade-forge.marketdata.candles.raw.v1`, в который поступают новые ("живые") свечи.
-   **Ключевые задачи:**
    1.  **Прием сырой свечи:** Получает новую свечу OHLCV.
    2.  **Расчет "горячих" индикаторов:** На основе полученной свечи и исторического контекста (последние N свечей из **Redis**) рассчитывает предопределенный набор "горячих" индикаторов. Список этих индикаторов определяется в **PostgreSQL** (таблица `trader_core.users_indicators`, флаг `is_hot`).
    3.  **Сохранение результатов:** Сохраняет рассчитанные значения индикаторов в **ClickHouse** (таблица `trader.candles_indicators`).
    4.  **Публикация "жирной" свечи:** Формирует и отправляет "жирную" свечу (OHLCV + значения всех горячих индикаторов) в Kafka-топик `trade-forge.indicators.candles.processed.rt.v1` для немедленной обработки торговым движком (RT Trading Engine).

### 2. Batch Processor

-   **Режим запуска:** `batch`
-   **Триггер:** Постоянно слушает Kafka-топик `trade-forge.backtesting.indicators.calculation-requested.v1`, в который поступают задачи от движка бэктестинга.
-   **Ключевые задачи:**
    1.  **Прием задачи на расчет:** Получает сообщение с `job_id`, тикером, таймфреймом, периодом и списком индикаторов, которые необходимо рассчитать.
    2.  **Загрузка исторических данных:** Загружает из **ClickHouse** необходимый диапазон сырых свечей (включая lookback-период для "прогрева" индикаторов).
    3.  **Пакетный расчет:** Выполняет расчет запрошенных индикаторов для всего массива данных.
    4.  **Пакетное сохранение:** Сохраняет все рассчитанные значения в **ClickHouse** (таблица `trader.candles_indicators`) одной или несколькими эффективными транзакциями.
    5.  **Уведомление о завершении:** Отправляет сообщение об успешном завершении расчета обратно движку бэктестинга в топик `trade-forge.backtests.requests.v1`, замыкая "круг почета".

## Взаимодействие с другими системами

-   **Вход:**
    -   (RT) Сырые свечи из `trade-forge.marketdata.candles.raw.v1`.
    -   (Batch) Задачи на расчет из `trade-forge.backtesting.indicators.calculation-requested.v1`.
-   **Выход:**
    -   (RT) "Жирные" свечи в `trade-forge.indicators.candles.processed.rt.v1`.
    -   (Batch) Сообщения о статусе в `trade-forge.backtests.requests.v1`.
-   **Зависимости:** Redis (для RT-контекста), PostgreSQL (для списка "горячих" индикаторов), ClickHouse (для хранения и чтения данных), Kafka.
