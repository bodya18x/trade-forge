# Trading Engine

## Назначение

Сервис `trading_engine` — это ядро принятия торговых решений платформы "Trade Forge". Он отвечает за применение логики пользовательских стратегий к рыночным данным для симуляции сделок (бэктестинг) и, в будущем, для реальной торговли.

## Архитектура и Режимы Работы

Сервис, как и `data_processor`, спроектирован для работы в двух изолированных режимах (контурах), чтобы ресурсоемкие задачи бэктестинга не влияли на производительность критически важной real-time торговли.

### 1. Backtest Worker (Реализован)

-   **Режим запуска:** `consume-backtest`
-   **Триггер:** Постоянно слушает Kafka-топик `trade-forge.backtests.requests.v1`, в который поступают задачи от `internal-api`.
-   **Ключевые задачи:**
    1.  **Прием задачи:** Получает `job_id` из Kafka.
    2.  **Оркестрация данных:**
        -   Извлекает из **PostgreSQL** полную информацию о задаче: параметры, тикер, период и AST-определение связанной стратегии.
        -   Анализирует AST, чтобы определить, какие индикаторы необходимы для расчета.
        -   Проверяет наличие и полноту данных по этим индикаторам в **ClickHouse**.
        -   Если данные отсутствуют или неполны, отправляет задачу на их расчет в `data_processor` через Kafka-топик `trade-forge.backtesting.indicators.calculation-requested.v1` и ожидает ответного сообщения (реализация паттерна "Круг почета").
    3.  **Симуляция (Backtesting):**
        -   После подтверждения наличия всех данных, загружает свечи и значения индикаторов из **ClickHouse** в `pandas.DataFrame`.
        -   Использует высокопроизводительный гибридный (векторизованный + пошаговый) движок для симуляции сделок на исторических данных в соответствии с логикой стратегии.
    4.  **Сохранение результатов:**
        -   Рассчитывает итоговые метрики производительности (ROI, Win Rate, Max Drawdown и т.д.).
        -   Сохраняет рассчитанные метрики и полный список симулированных сделок в **PostgreSQL** (таблица `trader_core.backtest_results`).
        -   Обновляет статус задачи в `trader_core.backtest_jobs` на `COMPLETED` или `FAILED`.

### 2. Real-Time (RT) Processor (В разработке)

-   **Режим запуска:** `consume-rt` (будущая реализация)
-   **Триггер:** Будет слушать Kafka-топик `trade-forge.indicators.candles.processed.rt.v1`, в который поступают "жирные" свечи от `data_processor`.
-   **Ключевые задачи:**
    1.  **Прием "жирной" свечи:** Получает свечу, уже обогащенную значениями всех "горячих" индикаторов.
    2.  **Прогон через активные стратегии:** Применяет логику всех активных пользовательских стратегий (помеченных для RT-торговли) к данным новой свечи.
    3.  **Генерация торговых сигналов:** Если условия какой-либо стратегии выполняются, генерирует торговый сигнал (например, `OPEN_LONG`, `CLOSE_POSITION`).
    4.  **Публикация приказов:** Отправляет сгенерированные сигналы в виде торговых приказов в Kafka-топик `trade-forge.trading.orders.v1` для дальнейшей обработки сервисом управления рисками и исполнения.

## Взаимодействие с другими системами

-   **Вход:**
    -   (Backtest) Задачи на бэктест из `trade-forge.backtests.requests.v1`.
    -   (RT, будущее) "Жирные" свечи из `trade-forge.indicators.candles.processed.rt.v1`.
-   **Выход:**
    -   (Backtest) Задачи на расчет индикаторов в `trade-forge.backtesting.indicators.calculation-requested.v1`.
    -   (RT, будущее) Торговые приказы в `trade-forge.trading.orders.v1`.
-   **Зависимости:** PostgreSQL (для метаданных задач и сохранения результатов), ClickHouse (для исторических данных), Kafka.
