# DataFlow: Обработка задач бэктестинга

## Общий процесс выполнения

### 0. Инициализация
Пул клиентов создаем и т.п.

### 1. Получение сообщения
Пришло сообщение - добавляем корреляционное ID.

### 2. Проверка клиента
Вытягиваем клиент ClickHouse из пула и проверяем его через `SELECT 1`.

### 3. Оркестрация
Из консьюмера идем в оркестрацию - там как раз идет вся обработка задачи.

### 4. Создание пайплайна
Создаем пайплайн "что за чем надо выполнить". По факту это список задач с учетом очередности выполнения.

#### Структура пайплайна:
- **A)** Валидация задачи (самой таски из базы)
- **B)** Анализ стратегии и извлечение индикаторов нужных для неё
- **C)** Проверка индикаторов в базе. Если чёт нет, то круг почета
- **D)** Загрузка данных уже для бектеста
- **E)** Симуляция бектеста
- **F)** Сохранение результатов в базу

> То есть выше описаны общие задачи и что за чем идет в логическом кейсе.

### 5. Запуск пайплайна
После инициализации пайплайна мы его запускаем в работу.

### 6. Итерация по шагам
Итерируемся по каждому шагу.

---

## Детальное описание шагов пайплайна

### A) Валидация задачи
- Вытягиваем детальную инфу о задаче из базы (стратегию, тикер, таймфрейм и т.п.)
- Вытягиваем инфу о тикере (да, на каждой задаче, но это делается по сути моментально)

### B) Анализ стратегии и извлечение индикаторов
Нужно вытянуть необходимые индикаторы из стратегии:

1. Вытягиваем из всех состояний (условий) стратегии ключи индикаторов
2. Запрашиваем из базы все возможные вариации индикаторов
   > ⚠️ **Кейс для оптимизации**: Если очень много индикаторов - проблема. Надо будет подумать как оптимизировать.
3. Сверяем что ключи, которые есть в стратегии существуют в этом списке
4. Возвращаем список индикаторов

### C) Проверка индикаторов
- Проверяем по текущим индикаторам (которые получили) и по свечам что временной промежуток покрыт **ВСЕМИ** расчетами (т.е. что все нужные для прогона стратегии индикаторы уже рассчитаны и ничего нам не нужно считать дальше)

#### Сценарий 1: Данные отсутствуют (КРУГ ПОЧЕТА)
- **ЕСЛИ** что-то пропущено - кидаем запрос в Kafka на сервис калькуляции и ждем повторный запрос от калькуляции что данные рассчитаны (этакий круг почета "КРУГ ПОЧЕТА")
- Дальше повторно заявка приходит и делает то же самое еще раз (всё что до этого)

#### Сценарий 2: Данные готовы
- **ЕСЛИ** всё хорошо, то всё хорошо, идем на следующий шаг

### D) Загрузка данных для бектеста
- Вытягиваем свечи и индикаторы из базы (списки словарей)
- Преобразовываем свечи и индикаторы в датафреймы
- Объединяем и имеем цельный широкий датафрейм

### E) Симуляция бектеста

#### Подготовка
- Формируем конфиг бектеста
  > ⚠️ **Кейс для доработки**: Тут есть кейс с обратной совместимостью, надо будет на это взглянуть и подправить.
- Инициализируем executor (класс исполнения бектеста)
- Запускаем сам бектест

#### Валидация и расчет условий
- Валидируем датафрейм
- Рассчитываем на основе свечей и индикаторов все условия входа/выхода
  > ⚠️ **Кейс для упрощения**: Тут вообще логика запутанная из-за рекурсий, можно будет подумать как это упростить с точки зрения понимания кода.
- Логируем статистику, чтобы в логах хранилась инфа (сколько сигналов лонг/шорт и т.п.)

#### Симуляция
Запускаем саму симуляцию бектеста:

1. **Кеширование данных**
   - Кешируем данные, чтобы работать с numpy array

2. **Итерация по свечам**
   
   Итерируемся по каждой свече. Проверяем:
   
   - **Если позиции НЕТ И ЕСТЬ сигнал на вход → ЗАХОДИМ**
   
   - **Если позиция ЕСТЬ:**
     - Проверяем "Нужно ли сдвинуть стоп-лосс или же нет?", если да, то двигаем стоп-лосс
     - Дальше проверяем все условия на выход из позиции (СЛ, ТП, просто сигнал на выход)
   
   - **ЕСЛИ получен сигнал на выход из предыдущего пункта:**
     - Рассчитываем трейд - т.к. у нас есть точка входа и выхода мы рассчитываем все нужные нам условия/метрики на основе трейда
     - Обнуляем временные метрики и сохраняем трейд для дальнейшего сохранения
   
   - Идем на следующую свечу и проверяем то же самое, пока не закончатся свечи

3. **Закрытие открытых позиций**
   - Если есть открытый трейд, но свечи закончились - закрываем позицию

### F) Сохранение результатов

- Рассчитываем метрики все
  > ⚠️ **Замечание**: Кстати странно что на этом этапе, как будто бы логично двинуть на прошлый этап.
- Сохраняем результат в базу (метрики, трейды)
- Обновляем статус задачи:
  - Обычную задачу завершаем
  - Если задача принадлежит пачке - обновляем количество завершенных задач в пачке и статус самой пачки

---

## 8. Завершение

Освобождаем клиент ClickHouse. **ВСЁ, задача завершена.**

---

## Известные точки оптимизации

1. **Шаг B**: Оптимизация запроса всех возможных вариаций индикаторов при большом их количестве
2. **Шаг E**: Упрощение логики с рекурсиями в расчете условий входа/выхода
3. **Шаг E**: Обратная совместимость в конфиге бектеста
4. **Шаг F**: Перенос расчета метрик на этап симуляции