# MOEX Data Collector

## Назначение

Сервис `moex_collector` отвечает за сбор, первичное хранение и публикацию рыночных данных (свечей) с **Московской биржи (MOEX)**. Он является отправной точкой всего конвейера данных платформы "Trade Forge".

## Архитектура и Режимы Работы

Сервис разделен на два независимых компонента (контейнера) для обеспечения отказоустойчивости и гибкости:

### 1. Scheduler (Планировщик)

-   **Режим запуска:** `schedule`
-   **Триггер:** Запускается по `cron`-расписанию.
-   **Ключевые задачи:**
    1.  **Синхронизация справочника тикеров:** Запрашивает у MOEX API актуальный список торгуемых акций, их параметры (лот, шаг цены и т.д.) и сохраняет/обновляет их в основной базе данных **PostgreSQL** (`trader_core.tickers`).
    2.  **Синхронизация состояния:** Периодически проверяет данные в **ClickHouse** и обновляет кэш **Redis**, чтобы обеспечить отказоустойчивость и избежать повторной загрузки исторических данных в случае очистки кэша.
    3.  **Инициация сбора данных:** Для каждого активного тикера отправляет сообщение-задачу (содержащее тикер и таймфрейм) в Kafka-топик `trade-forge.market-collectors.tasks`.

### 2. Consumer (Сборщик)

-   **Режим запуска:** `consume`
-   **Триггер:** Постоянно слушает Kafka-топик `trade-forge.market-collectors.tasks`.
-   **Ключевые задачи:**
    1.  **Получение задачи:** Принимает сообщение с тикером и таймфреймом.
    2.  **Сбор данных:** Обращается к MOEX API для получения исторических свечей. Использует **Redis** для определения, с какой даты начинать сбор, чтобы не скачивать уже имеющиеся данные.
    3.  **Пакетное сохранение:** Всю полученную пачку сырых свечей сохраняет в **ClickHouse** (таблица `trader.candles_base`) одной эффективной транзакцией.
    4.  **Публикация новых свечей:** Фильтрует только *новые* свечи и публикует их в Kafka-топик `trade-forge.marketdata.candles.raw.v1` для дальнейшей обработки другими сервисами (например, `data_processor`).
    5.  **Циклический сбор:** Если от API была получена полная пачка свечей (лимит 500), задача на сбор этого тикера отправляется в Kafka повторно для загрузки следующей страницы истории.

## Взаимодействие с другими системами

-   **Вход:** Задачи из Kafka-топика `trade-forge.market-collectors.tasks`.
-   **Выход:**
    -   Сырые свечи в Kafka-топик `trade-forge.marketdata.candles.raw.v1`.
    -   Данные по тикерам в **PostgreSQL**.
    -   Сырые свечи в **ClickHouse**.
-   **Зависимости:** Redis, PostgreSQL, ClickHouse, Kafka.
