"""
–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
"""

from __future__ import annotations

from typing import Annotated

from fastapi import APIRouter, Depends
from redis.asyncio import Redis
from sqlalchemy.ext.asyncio import AsyncSession
from tradeforge_db import get_db_session

from app.core.redis import get_main_redis
from app.schemas.auth import (
    ExtendedLogoutRequest,
    ExtendedLogoutResponse,
    ExtendedRefreshRequest,
    ExtendedTokenResponse,
)
from app.services.auth_service import AuthService

router = APIRouter()


def get_auth_service(
    redis: Annotated[Redis, Depends(get_main_redis)],
) -> AuthService:
    """–ü–æ–ª—É—á–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏."""
    return AuthService(redis=redis)


@router.post(
    "/refresh",
    response_model=ExtendedTokenResponse,
    summary="–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å Refresh Token Rotation",
    description="""
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

    **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
    - **Refresh Token Rotation**: –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π refresh —Ç–æ–∫–µ–Ω
    - **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    - **Session binding**: —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å–µ—Å—Å–∏—è–º –≤ –ë–î
    - **Security logging**: –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

    **–ê–ª–≥–æ—Ä–∏—Ç–º Refresh Token Rotation:**
    1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –≤ blacklist
    3. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ blacklist)
    4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ù–û–í–û–ì–û refresh —Ç–æ–∫–µ–Ω–∞
    5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞
    6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ –ë–î
    7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ CSRF —Ç–æ–∫–µ–Ω–∞
    8. –í–æ–∑–≤—Ä–∞—Ç –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏ CSRF —Ç–æ–∫–µ–Ω–∞

    **üî• –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫**
    –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π refresh —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ, —Å–∏—Å—Ç–µ–º–∞:
    - –£–¥–∞–ª—è–µ—Ç –í–°–ï —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    - –¢—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

    **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
    - –ö–∞–∂–¥—ã–π refresh —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑
    - JTI –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –ë–î, –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Üí terminate –≤—Å–µ —Å–µ—Å—Å–∏–∏
    - Refresh token –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ JSON body (–Ω–µ cookie), CSRF –∞—Ç–∞–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
    - –í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞

    **–ü–æ—á–µ–º—É –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è CSRF —Ç–æ–∫–µ–Ω:**
    - Refresh token –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–µ cookie)
    - CSRF –∞—Ç–∞–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è refresh token, —á—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
    - Refresh Token Rotation —É–∂–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    - –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º OAuth 2.0 –∏ JWT best practices
    """,
)
async def refresh_token_extended(
    request: ExtendedRefreshRequest,
    db: Annotated[AsyncSession, Depends(get_db_session)],
    auth_service: Annotated[AuthService, Depends(get_auth_service)],
):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã —Å Refresh Token Rotation.

    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç refresh —Ç–æ–∫–µ–Ω
    - –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–π refresh —Ç–æ–∫–µ–Ω
    - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–µ–π
    - –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

    –í–ê–ñ–ù–û: CSRF —Ç–æ–∫–µ–Ω –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç.–∫.:
    - Refresh token –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ JSON body (–Ω–µ cookie)
    - Refresh Token Rotation –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É (1 —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    - CSRF –∞—Ç–∞–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–µ–∑ –∑–Ω–∞–Ω–∏—è refresh token
    """
    token_data = await auth_service.refresh_tokens(
        db=db, refresh_token=request.refresh_token
    )
    return ExtendedTokenResponse(**token_data)


@router.post(
    "/logout",
    response_model=ExtendedLogoutResponse,
    summary="–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã",
    description="""
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π session management.

    **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
    - **–í—ã–±–æ—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π**: –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –∏–ª–∏ –≤—Å–µ —Å–µ—Å—Å–∏–∏
    - **Session management**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –≤ –ë–î
    - **Security logging**: –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤—ã—Ö–æ–¥–∞
    - **Blacklist management**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ blacklist

    **–ü—Ä–æ—Ü–µ—Å—Å –≤—ã—Ö–æ–¥–∞:**
    1. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç refresh —Ç–æ–∫–µ–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é
    2. –î–æ–±–∞–≤–ª—è–µ—Ç refresh —Ç–æ–∫–µ–Ω –≤ blacklist
    3. –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é (–∏–ª–∏ –≤—Å–µ —Å–µ—Å—Å–∏–∏) –≤ –ë–î
    4. –õ–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤—ã—Ö–æ–¥–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞
    5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π

    **–û–ø—Ü–∏—è logout_all_devices:**
    - `false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
    - `true`: –∑–∞–≤–µ—Ä—à–∞–µ—Ç –í–°–ï —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

    **Use cases:**
    - –û–±—ã—á–Ω—ã–π –≤—ã—Ö–æ–¥: `logout_all_devices: false`
    - –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –≤–∑–ª–æ–º: `logout_all_devices: true`
    - –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è: `logout_all_devices: true`

    **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
    - –í—Å–µ —Ç–æ–∫–µ–Ω—ã —Å–µ—Å—Å–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ blacklist
    - –°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    - Graceful handling –ø—Ä–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö
    """,
)
async def logout_extended(
    request: ExtendedLogoutRequest,
    db: Annotated[AsyncSession, Depends(get_db_session)],
    auth_service: Annotated[AuthService, Depends(get_auth_service)],
):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã.

    - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç refresh —Ç–æ–∫–µ–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é
    - –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é(–∏) –≤ –ë–î
    - –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ blacklist
    - –õ–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    """
    logout_data = await auth_service.logout_user(
        db=db,
        refresh_token=request.refresh_token,
        logout_all_devices=request.logout_all_devices,
    )
    return ExtendedLogoutResponse(**logout_data)
